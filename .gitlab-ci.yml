# This file is generated by script 'ferrite/ferrite/ci/gitlab/generate.py'

image: agerasev/debian-psc

variables:
  GIT_SUBMODULE_STRATEGY: "recursive"
  POETRY_VIRTUALENVS_IN_PROJECT: "true"

cache: &global_cache
  - key:
      files:
        - pyproject.toml
        - poetry.lock
    paths:
      - .venv/

stages:
  - "-1"
  - "0"
  - "1"
  - "2"
  - "3"
  - "4"

yapf:
  stage: "-1"
  script:
    - poetry install
    - poetry run yapf --diff --recursive tornado
  allow_failure: true

mypy:
  stage: "-1"
  script:
    - poetry install
    - poetry run mypy -p tornado
  allow_failure: true

host.ipp.generate:
  stage: "0"
  script:
    - poetry install
    - poetry run python -u -m tornado.manage --no-deps --no-capture host.ipp.generate
  artifacts:
    paths:
      - target/ipp_generated

host.epics_base.clone:
  stage: "0"
  script:
    - poetry install
    - poetry run python -u -m tornado.manage --no-deps --no-capture host.epics_base.clone
  artifacts:
    paths:
      - target/epics_base_7.0.4.1_src
  cache:
    - *global_cache
    - key: "host.epics_base.clone:a1a70a21"
      paths:
        - target/epics_base_7.0.4.1_src

device.mcu_toolchain.download:
  stage: "0"
  script:
    - poetry install
    - poetry run python -u -m tornado.manage --no-deps --no-capture device.mcu_toolchain.download
  artifacts:
    paths:
      - target/toolchain_gcc-arm-none-eabi-9-2020-q2-update
  cache:
    - *global_cache
    - key: "device.mcu_toolchain.download:ebbf11e3"
      paths:
        - target/toolchain_gcc-arm-none-eabi-9-2020-q2-update

device.freertos.clone:
  stage: "0"
  script:
    - poetry install
    - poetry run python -u -m tornado.manage --no-deps --no-capture device.freertos.clone
  artifacts:
    paths:
      - target/mcuxpresso_sdk_2.9.x-var01
  cache:
    - *global_cache
    - key: "device.freertos.clone:dcfe0c26"
      paths:
        - target/mcuxpresso_sdk_2.9.x-var01

device.app_toolchain.download:
  stage: "0"
  script:
    - poetry install
    - poetry run python -u -m tornado.manage --no-deps --no-capture device.app_toolchain.download
  artifacts:
    paths:
      - target/toolchain_gcc-linaro-7.5.0-2019.12-x86_64_aarch64-linux-gnu
  cache:
    - *global_cache
    - key: "device.app_toolchain.download:f68a15dd"
      paths:
        - target/toolchain_gcc-linaro-7.5.0-2019.12-x86_64_aarch64-linux-gnu

host.ipp.build:
  stage: "1"
  script:
    - poetry install
    - poetry run python -u -m tornado.manage --no-deps --no-capture host.ipp.build
  needs:
    - host.ipp.generate
  artifacts:
    paths:
      - target/ipp_host

host.epics_base.build:
  stage: "1"
  script:
    - poetry install
    - poetry run python -u -m tornado.manage --no-deps --no-capture host.epics_base.build
  needs:
    - host.epics_base.clone
  artifacts:
    paths:
      - target/epics_base_7.0.4.1_build_host
      - target/epics_base_7.0.4.1_install_host
  cache:
    - *global_cache
    - key: "host.epics_base.build:a91afc"
      paths:
        - target/epics_base_7.0.4.1_build_host
        - target/epics_base_7.0.4.1_install_host

host.app.build:
  stage: "1"
  script:
    - poetry install
    - poetry run python -u -m tornado.manage --no-deps --no-capture host.app.build
  needs:
    - host.ipp.generate
  artifacts:
    paths:
      - target/app_host

device.mcu.build:
  stage: "1"
  script:
    - poetry install
    - poetry run python -u -m tornado.manage --no-deps --no-capture device.mcu.build
  needs:
    - device.freertos.clone
    - device.mcu_toolchain.download
    - host.ipp.generate
  artifacts:
    paths:
      - target/mcu

device.app.build:
  stage: "1"
  script:
    - poetry install
    - poetry run python -u -m tornado.manage --no-deps --no-capture device.app.build
  needs:
    - device.app_toolchain.download
    - host.ipp.generate
  artifacts:
    paths:
      - target/app_imx8mn

host.ipp.test:
  stage: "2"
  script:
    - poetry install
    - poetry run python -u -m tornado.manage --no-deps --no-capture host.ipp.test
  needs:
    - host.ipp.build

host.ioc.build:
  stage: "2"
  script:
    - poetry install
    - poetry run python -u -m tornado.manage --no-deps --no-capture host.ioc.build
  needs:
    - host.app.build
    - host.epics_base.build
  artifacts:
    paths:
      - target/ioc_build_host
      - target/ioc_install_host

device.epics_base.build:
  stage: "2"
  script:
    - poetry install
    - poetry run python -u -m tornado.manage --no-deps --no-capture device.epics_base.build
  needs:
    - device.app_toolchain.download
    - host.epics_base.build
  artifacts:
    paths:
      - target/epics_base_7.0.4.1_build_imx8mn
      - target/epics_base_7.0.4.1_install_imx8mn
  cache:
    - *global_cache
    - key: "device.epics_base.build:6c101c42"
      paths:
        - target/epics_base_7.0.4.1_build_imx8mn
        - target/epics_base_7.0.4.1_install_imx8mn

host.ioc.test_fakedev:
  stage: "3"
  script:
    - poetry install
    - poetry run python -u -m tornado.manage --no-deps --no-capture host.ioc.test_fakedev
  needs:
    - host.epics_base.build
    - host.ioc.build

device.ioc.build:
  stage: "3"
  script:
    - poetry install
    - poetry run python -u -m tornado.manage --no-deps --no-capture device.ioc.build
  needs:
    - device.app.build
    - device.app_toolchain.download
    - device.epics_base.build
  artifacts:
    paths:
      - target/ioc_build_imx8mn
      - target/ioc_install_imx8mn

host.all.test:
  stage: "4"
  script:
    - poetry install
    - poetry run python -u -m tornado.manage --no-deps --no-capture host.all.test
  needs:
    - host.ioc.test_fakedev
    - host.ipp.test

device.all.build:
  stage: "4"
  script:
    - poetry install
    - poetry run python -u -m tornado.manage --no-deps --no-capture device.all.build
  needs:
    - device.epics_base.build
    - device.ioc.build
    - device.mcu.build
