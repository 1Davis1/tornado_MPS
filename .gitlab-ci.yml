# This file is generated by script 'ci/gitlab.py'

image: agerasev/debian-psc

stages:
  - "0"
  - "1"
  - "2"
  - "3"
  - "4"
  - "5"

mcu_toolchain.download:
  stage: "0"
  script:
    - python3 -u -m manage --no-deps mcu_toolchain.download
  artifacts:
    paths:
      - target/toolchain_gcc-arm-none-eabi-5_4-2016q3

freertos.clone:
  stage: "0"
  script:
    - python3 -u -m manage --no-deps freertos.clone
  artifacts:
    paths:
      - target/freertos_bsp_1.0.1_imx7d-var01

epics_base.clone:
  stage: "0"
  script:
    - python3 -u -m manage --no-deps epics_base.clone
  artifacts:
    paths:
      - target/epics_base_7.0.4.1_src

app_toolchain.download:
  stage: "0"
  script:
    - python3 -u -m manage --no-deps app_toolchain.download
  artifacts:
    paths:
      - target/toolchain_gcc-linaro-7.5.0-2019.12-x86_64_arm-linux-gnueabihf

app.build_unittest:
  stage: "0"
  script:
    - python3 -u -m manage --no-deps app.build_unittest
  artifacts:
    paths:
      - target/app_host

mcu.build:
  stage: "1"
  script:
    - python3 -u -m manage --no-deps mcu.build
  needs:
    - mcu_toolchain.download
    - freertos.clone
  artifacts:
    paths:
      - target/mcu

epics_base.build_host:
  stage: "1"
  script:
    - python3 -u -m manage --no-deps epics_base.build_host
  needs:
    - epics_base.clone
  artifacts:
    paths:
      - target/epics_base_7.0.4.1_host_build
      - target/epics_base_7.0.4.1_host_install

app.run_unittest:
  stage: "1"
  script:
    - python3 -u -m manage --no-deps app.run_unittest
  needs:
    - app.build_unittest

epics_base.build_cross:
  stage: "2"
  script:
    - python3 -u -m manage --no-deps epics_base.build_cross
  needs:
    - app_toolchain.download
    - epics_base.build_host
  artifacts:
    paths:
      - target/epics_base_7.0.4.1_cross_build
      - target/epics_base_7.0.4.1_cross_install

app.build_fakedev:
  stage: "2"
  script:
    - python3 -u -m manage --no-deps app.build_fakedev
  needs:
    - epics_base.build_host
  artifacts:
    paths:
      - target/app_host

ioc.build_host:
  stage: "3"
  script:
    - python3 -u -m manage --no-deps ioc.build_host
  needs:
    - epics_base.build_host
    - app.build_fakedev
  artifacts:
    paths:
      - target/ioc_host_build
      - target/ioc_host_install

app.build_main_cross:
  stage: "3"
  script:
    - python3 -u -m manage --no-deps app.build_main_cross
  needs:
    - app_toolchain.download
    - epics_base.build_cross
  artifacts:
    paths:
      - target/app_cross

ioc.build_cross:
  stage: "4"
  script:
    - python3 -u -m manage --no-deps ioc.build_cross
  needs:
    - app_toolchain.download
    - epics_base.build_cross
    - app.build_main_cross
  artifacts:
    paths:
      - target/ioc_cross_build
      - target/ioc_cross_install

ioc.test_fakedev:
  stage: "4"
  script:
    - python3 -u -m manage --no-deps ioc.test_fakedev
  needs:
    - epics_base.build_host
    - ioc.build_host

all.build:
  stage: "5"
  script:
    - python3 -u -m manage --no-deps all.build
  needs:
    - mcu.build
    - epics_base.build_host
    - epics_base.build_cross
    - app.build_unittest
    - app.build_fakedev
    - ioc.build_host
    - ioc.build_cross

all.test_host:
  stage: "5"
  script:
    - python3 -u -m manage --no-deps all.test_host
  needs:
    - app.run_unittest
    - ioc.test_fakedev

