# This file is generated by script 'ferrite/ferrite/ci/gitlab/generate.py'

image: agerasev/debian-psc

variables:
  GIT_SUBMODULE_STRATEGY: "recursive"
  POETRY_VIRTUALENVS_IN_PROJECT: "true"

cache: &global_cache
  - key:
      files:
        - pyproject.toml
        - poetry.lock
    paths:
      - .venv/

stages:
  - "-1"
  - "0"
  - "1"
  - "2"
  - "3"
  - "4"

yapf:
  stage: "-1"
  script:
    - poetry install
    - poetry run yapf --diff --recursive tornado
  allow_failure: true

mypy:
  stage: "-1"
  script:
    - poetry install
    - poetry run mypy -p tornado
  allow_failure: true

host.ipp.generate:
  stage: "0"
  script:
    - poetry install
    - poetry run python -u -m tornado.manage --no-deps --no-capture host.ipp.generate
  artifacts:
    paths:
      - target/ipp

host.epics_base.clone:
  stage: "0"
  script:
    - poetry install
    - poetry run python -u -m tornado.manage --no-deps --no-capture host.epics_base.clone
  artifacts:
    paths:
      - target/epics_base_7.0.6.1_src
  cache:
    - *global_cache
    - key: "host.epics_base.clone:a1b50a23"
      paths:
        - target/epics_base_7.0.6.1_src

device.mcu_toolchain.download:
  stage: "0"
  script:
    - poetry install
    - poetry run python -u -m tornado.manage --no-deps --no-capture device.mcu_toolchain.download
  artifacts:
    paths:
      - target/toolchain_gcc-arm-none-eabi-10-2020-q4-major
  cache:
    - *global_cache
    - key: "device.mcu_toolchain.download:e97411a3"
      paths:
        - target/toolchain_gcc-arm-none-eabi-10-2020-q4-major

device.freertos.clone:
  stage: "0"
  script:
    - poetry install
    - poetry run python -u -m tornado.manage --no-deps --no-capture device.freertos.clone
  artifacts:
    paths:
      - target/mcuxpresso_sdk_2.10.x-var01
  cache:
    - *global_cache
    - key: "device.freertos.clone:e8070c4e"
      paths:
        - target/mcuxpresso_sdk_2.10.x-var01

device.app_toolchain.download:
  stage: "0"
  script:
    - poetry install
    - poetry run python -u -m tornado.manage --no-deps --no-capture device.app_toolchain.download
  artifacts:
    paths:
      - target/toolchain_gcc-arm-10.2-2020.11-x86_64-aarch64-none-linux-gnu
  cache:
    - *global_cache
    - key: "device.app_toolchain.download:f93a1603"
      paths:
        - target/toolchain_gcc-arm-10.2-2020.11-x86_64-aarch64-none-linux-gnu

host.ipp.build:
  stage: "1"
  script:
    - poetry install
    - poetry run python -u -m tornado.manage --no-deps --no-capture host.ipp.build
  needs:
    - host.ipp.generate
  artifacts:
    paths:
      - target/ipp_test

host.epics_base.build:
  stage: "1"
  script:
    - poetry install
    - poetry run python -u -m tornado.manage --no-deps --no-capture host.epics_base.build
  needs:
    - host.epics_base.clone
  artifacts:
    paths:
      - target/epics_base_7.0.6.1_build_host
      - target/epics_base_7.0.6.1_install_host
  cache:
    - *global_cache
    - key: "host.epics_base.build:1331b00"
      paths:
        - target/epics_base_7.0.6.1_build_host
        - target/epics_base_7.0.6.1_install_host

host.app.build:
  stage: "1"
  script:
    - poetry install
    - poetry run python -u -m tornado.manage --no-deps --no-capture host.app.build
  needs:
    - host.ipp.generate
  artifacts:
    paths:
      - target/app_fakedev

device.mcu.build:
  stage: "1"
  script:
    - poetry install
    - poetry run python -u -m tornado.manage --no-deps --no-capture device.mcu.build
  needs:
    - device.freertos.clone
    - device.mcu_toolchain.download
    - host.ipp.generate
  artifacts:
    paths:
      - target/mcu

device.app.build:
  stage: "1"
  script:
    - poetry install
    - poetry run python -u -m tornado.manage --no-deps --no-capture device.app.build
  needs:
    - device.app_toolchain.download
    - host.ipp.generate
  artifacts:
    paths:
      - target/app_imx8mn

host.ipp.test:
  stage: "2"
  script:
    - poetry install
    - poetry run python -u -m tornado.manage --no-deps --no-capture host.ipp.test
  needs:
    - host.ipp.build

host.ioc_fakedev.build:
  stage: "2"
  script:
    - poetry install
    - poetry run python -u -m tornado.manage --no-deps --no-capture host.ioc_fakedev.build
  needs:
    - host.app.build
    - host.epics_base.build
  artifacts:
    paths:
      - target/ioc_build_host
      - target/ioc_install_host

device.epics_base.build:
  stage: "2"
  script:
    - poetry install
    - poetry run python -u -m tornado.manage --no-deps --no-capture device.epics_base.build
  needs:
    - device.app_toolchain.download
    - host.epics_base.build
  artifacts:
    paths:
      - target/epics_base_7.0.6.1_build_imx8mn
      - target/epics_base_7.0.6.1_install_imx8mn
  cache:
    - *global_cache
    - key: "device.epics_base.build:6ca61c46"
      paths:
        - target/epics_base_7.0.6.1_build_imx8mn
        - target/epics_base_7.0.6.1_install_imx8mn

host.ioc_fakedev.test:
  stage: "3"
  script:
    - poetry install
    - poetry run python -u -m tornado.manage --no-deps --no-capture host.ioc_fakedev.test
  needs:
    - host.epics_base.build
    - host.ioc_fakedev.build

device.ioc.build:
  stage: "3"
  script:
    - poetry install
    - poetry run python -u -m tornado.manage --no-deps --no-capture device.ioc.build
  needs:
    - device.app.build
    - device.app_toolchain.download
    - device.epics_base.build
  artifacts:
    paths:
      - target/ioc_build_imx8mn
      - target/ioc_install_imx8mn

host.all.test:
  stage: "4"
  script:
    - poetry install
    - poetry run python -u -m tornado.manage --no-deps --no-capture host.all.test
  needs:
    - host.ioc_fakedev.test
    - host.ipp.test

device.all.build:
  stage: "4"
  script:
    - poetry install
    - poetry run python -u -m tornado.manage --no-deps --no-capture device.all.build
  needs:
    - device.epics_base.build
    - device.ioc.build
    - device.mcu.build
